!function(a){"use strict";var b=a.extend({fieldClass:".comment-form-gv-review,.gv-star-rate-holder,.gv-vote-rating",respondId:"#respond",respondTempId:"#gv-ratings-reviews-temp-respond",commentParentId:"#comment_parent",commentId:"#comment",commentLabel:'label[for="comment"]:first',commentSubmit:'input[name="submit"]:first',replyTextId:"#reply-title",cancelId:"#cancel-comment-reply-link"},GV_RATINGS_REVIEWS);b.init=function(){b._holder=".gv-star-rate-holder, .gv-vote-rate-holder",b._star=".gv-star-rate",b._vote=".gv-vote-up, .gv-vote-down",b._input=".gv-star-rate-field",b._text=".gv-vote-rating-text",b._mutated=".gv-rate-mutated",b.$field=a(b._input),b.reply=a(".comment-reply-login, .comment-reply-link"),b.reply.removeAttr("onclick"),b.reply.on("click",b.moveForm),b.starHolder=a(b._holder),b.star=b.starHolder.find(b._star),b.star.on("click touchend",b.starRateReview).on("mouseover",b.mouseOverStar).on("mouseout",b.mouseOutStar),0!==parseInt(b.$field.val(),10)&&b.star.eq(parseInt(b.$field.val(),10)-1).trigger("click"),b.voteHolder=a(".gv-vote-rate-holder"),b.vote=a("a.gv-vote-up, a.gv-vote-down",b.voteHolder),b.vote.on("click touchend",b.voteRateReview),b.originalReplyText=b.getText(a(b.replyTextId)),b.originalCancelReplyText=b.getText(a(b.cancelId)),b.originalCommentLabelText=b.getText(a(b.commentLabel)),b.originalCommentSubmitText=a(b.commentSubmit).val()},b.moveForm=function(c){var d=a(c.target).parent().parent(),e=a(b.respondId),f=a(b.respondTempId),g=a(b.commentParentId),h=a(b.fieldClass);return f.length||(f=a("<div></div>"),f.attr("id",b.respondTempId.substr(1)),f.hide(),e.parent().append(f)),d.append(e),g.val(d.data("review_id")),h.hide(),b.replaceReplyText(b.comment_to_review_text,b.cancel_comment_to_review_text,b.comment_label_when_reply,b.comment_submit_when_reply),a(b.cancelId).show().on("click",b.cancelReply),a(b.commentId).focus(),!1},b.getText=function(b){return b=a(b),b.clone().children().remove().end().text()},b.replaceReplyText=function(c,d,e,f){var g=a(b.replyTextId),h=a(b.cancelId),i=a(b.commentLabel),j=a(b.commentSubmit);g.contents().each(function(){this.nodeType===this.TEXT_NODE&&(this.nodeValue=this.nodeValue.trim(),this.nodeValue.length&&(this.nodeValue=c))}),h.text(d),i.text(e),j.val(f)},b.cancelReply=function(c){var d=a(b.respondTempId),e=a(b.respondId),f=a(b.commentParentId),g=a(c.target),h=a(b.fieldClass);if(d.length&&e.length)return f.val(0),d.parent().append(e),d.remove(),b.replaceReplyText(b.originalReplyText,b.originalCancelReplyText,b.originalCommentLabelText,b.originalCommentSubmitText),g.hide(),g.off("click",b.cancelReply),h.show(),!1},b.mouseOverStar=function(c){var d=a(this),e=d.parents(b._holder),f=e.find(b._star),g=f.index(d);f.removeClass("gv-rate-mutated").each(function(b,c){var d=a(c);b>=g+1||d.addClass("gv-rate-mutated")})},b.mouseOutStar=function(c){var d=parseInt(a(this).parent().attr("data-star-rating"),10);if(b.multiple_entries&&d>=0){var e=0;return void a(this).parent().find(".gv-star-rate").each(function(){a(this).removeClass("gv-rate-mutated"),e<d&&a(this).addClass("gv-rate-mutated"),++e})}a(this).parents(b._holder).find(b._star).removeClass("gv-rate-mutated").filter('[data-selected="1"]').addClass("gv-rate-mutated")},b.starRateReview=function(c){c.stopPropagation();var d=a(this),e=d.parents(b._holder),f=e.find(b._star),g=e.siblings(b._input),h=f.index(d);if(g.val(h+1),f.removeClass("gv-rate-mutated").attr("data-selected",0).each(function(b,c){var d=a(c);b>=h+1||d.addClass("gv-rate-mutated").attr("data-selected",1)}),b.multiple_entries){var i=a(this).parent(),j=i.attr("data-star-rating"),k=i.find(".gv-rate-mutated").length,l=!1;i.attr("data-star-rating",k),a.ajax({type:"post",dataType:"json",url:b.ajaxurl,data:{action:b.action,nonce:b.nonce,view_id:i.attr("data-view-id"),comment_id:i.attr("data-comment-id"),entry_id:i.attr("data-entry-id"),update_rating:i.attr("data-rated"),rating:k,type:"star"},beforeSend:function(){i.animate({opacity:.5},200).attr("aria-busy","true")},success:function(a){a.success?(i.attr("data-rated",!0),i.attr("data-comment-id",a.data.comment_id)):l=!0},error:function(){l=!0},complete:function(){l&&i.attr("data-star-rating",j),i.animate({opacity:1},200).attr("aria-busy","false"),a(c.target).trigger("mouseout")}})}},b.voteRateReview=function(c){var d=a(this),e=d.parents(b._holder),f=e.find(b._vote),g=e.siblings(b._input),h=e.find(b._text),i=f.filter(b._mutated),j=d.is(i)?0:d.hasClass("gv-vote-up")?1:-1,k=0===j?b.vote_zero:1===j?b.vote_up:b.vote_down,l=0===j?b.vote_zero:_.template(b.vote_text_format)({number:j});if(b.ajaxurl){var m=a(this).parent(),n=m.attr("data-vote"),o=h.text(),p=h.attr("title"),q=!1;a.ajax({type:"post",dataType:"json",url:b.ajaxurl,data:{action:b.action,nonce:b.nonce,view_id:m.attr("data-view-id"),comment_id:m.attr("data-comment-id"),entry_id:m.attr("data-entry-id"),update_rating:m.attr("data-rated"),type:"vote",rating:String(j)},beforeSend:function(){m.animate({opacity:.5},200).attr("aria-busy","true")},success:function(a){a.success?(m.attr("data-rated",!0),m.attr("data-comment-id",a.data.comment_id)):q=!0},error:function(){q=!0},complete:function(){q&&(e.find("a").removeClass("gv-rate-mutated"),1==n?e.find("a.gv-vote-up").addClass("gv-rate-mutated"):-1==n&&e.find("a.gv-vote-down").addClass("gv-rate-mutated"),h.text(o).attr("title",p)),m.animate({opacity:1},200).attr("aria-busy","false")}})}return f.removeClass("gv-rate-mutated"),0!==j&&d.addClass("gv-rate-mutated"),h.text(k).attr("title",l),g.val(j),!1},a(b.init)}(jQuery,_);